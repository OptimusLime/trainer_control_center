---
import Layout from '../layouts/Layout.astro';
import LossChart from '../components/LossChart.tsx';
import TrainingMetricsChart from '../components/TrainingMetricsChart.tsx';
---

<Layout title="ACC Dashboard">
  <div class="dashboard">
    <!-- Checkpoint Context Bar -->
    <header class="header">
      <div class="checkpoint-context" id="checkpoint-context">
        <div class="checkpoint-tag" id="checkpoint-tag">Connecting...</div>
        <div class="checkpoint-detail" id="checkpoint-detail"></div>
      </div>
      <div class="live-stats">
        <div class="live-stat">
          <span class="live-stat-value" id="step-value">--</span>
          <span class="live-stat-label">steps</span>
        </div>
        <div class="live-stat">
          <span class="live-stat-value" id="loss-value">--</span>
          <span class="live-stat-label">loss</span>
        </div>
        <div class="live-stat">
          <div id="health-badge" class="health-badge">
            <span class="health-dot" id="health-dot" style="background: #8b949e;"></span>
            <span id="health-text">--</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="panel" id="model-panel">
        <h3>Model</h3>
        <div class="empty">No model loaded</div>
      </div>

      <div class="panel" id="loss-summary-panel">
        <h3>Loss Summary</h3>
        <div class="empty">No training data</div>
      </div>

      <div class="panel" id="recipe-panel">
        <h3>Recipe</h3>
        <div class="empty">No recipe running</div>
      </div>

      <div class="panel" id="job-history-panel">
        <h3>Job History</h3>
        <div class="empty">No jobs</div>
      </div>

      <div class="panel" id="checkpoint-tree-panel">
        <div class="panel-header">
          <h3>Checkpoints</h3>
          <button class="btn-action" id="btn-save-toggle">Save</button>
        </div>
        <div id="save-form" class="save-form" style="display:none;">
          <input type="text" id="save-tag" class="save-input" placeholder="checkpoint tag..." />
          <button class="btn-action btn-save" id="btn-save">Save Checkpoint</button>
        </div>
        <div class="empty">No checkpoints</div>
      </div>

      <!-- M-UI-5: Tasks -->
      <div class="panel" id="tasks-panel">
        <h3>Tasks</h3>
        <div class="empty">No tasks configured</div>
      </div>

      <!-- M-UI-5: Training Controls -->
      <div class="panel" id="training-panel">
        <h3>Training</h3>
        <div class="train-controls">
          <div class="train-row">
            <label class="train-label">Steps</label>
            <input type="number" id="train-steps" class="train-input" value="500" min="1" />
          </div>
          <div class="train-row">
            <label class="train-label">LR</label>
            <input type="number" id="train-lr" class="train-input" value="0.001" step="0.0001" min="0" />
          </div>
          <div class="train-buttons">
            <button class="btn-action btn-train-start" id="btn-train-start">Start Training</button>
            <button class="btn-action btn-train-stop" id="btn-train-stop" disabled>Stop</button>
          </div>
        </div>
      </div>

      <!-- M-UI-5: Device -->
      <div class="panel" id="device-panel">
        <h3>Device</h3>
        <div class="device-row">
          <select id="device-select" class="compare-select"></select>
        </div>
      </div>

      <!-- M-UI-5: Recipes -->
      <div class="panel" id="recipes-panel">
        <h3>Run Recipe</h3>
        <div class="empty">No recipes available</div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="panel">
        <h3>Loss Curves</h3>
        <LossChart client:load />
      </div>

      <!-- Training Metrics (gating entropy, gradient CV) — auto-hides when no data -->
      <TrainingMetricsChart client:load />

      <!-- Eval -->
      <div class="panel" id="eval-panel">
        <div class="panel-header">
          <h3>Eval Metrics</h3>
          <button class="btn-action" id="btn-eval">Run Eval</button>
        </div>
        <div class="empty">Click "Run Eval" to evaluate the current model</div>
      </div>

      <!-- Reconstructions -->
      <div class="panel" id="recon-panel">
        <div class="panel-header">
          <h3>Reconstructions</h3>
          <button class="btn-action" id="btn-recon">Generate</button>
        </div>
        <div class="empty">Click "Generate" to see input vs reconstruction</div>
      </div>

      <!-- Checkpoint Comparison -->
      <div class="panel" id="compare-panel">
        <div class="panel-header">
          <h3>Checkpoint Comparison</h3>
          <div class="compare-controls">
            <select id="compare-select" class="compare-select">
              <option value="">Select checkpoint...</option>
            </select>
            <button class="btn-action" id="btn-compare" disabled>Compare</button>
          </div>
        </div>
        <div class="empty">Select a checkpoint to compare against the current model</div>
      </div>

      <!-- Weight Features -->
      <div class="panel" id="features-panel">
        <div class="panel-header">
          <h3>Weight Features</h3>
          <button class="btn-action" id="btn-features">Load Features</button>
        </div>
        <div class="empty">Load features to visualize encoder weight patterns across checkpoints</div>
      </div>

      <!-- M-UI-5: Add Task -->
      <div class="panel" id="add-task-panel">
        <h3>Add Task</h3>
        <div class="add-task-form">
          <div class="train-row">
            <label class="train-label">Type</label>
            <select id="task-class" class="compare-select"></select>
          </div>
          <div class="train-row">
            <label class="train-label">Name</label>
            <input type="text" id="task-name" class="train-input" placeholder="my_task" />
          </div>
          <div class="train-row">
            <label class="train-label">Dataset</label>
            <select id="task-dataset" class="compare-select"></select>
          </div>
          <div class="train-row">
            <label class="train-label">Weight</label>
            <input type="number" id="task-weight" class="train-input" value="1.0" step="0.1" min="0" />
          </div>
          <button class="btn-action" id="btn-add-task">Add Task</button>
        </div>
      </div>

      <!-- M-UI-5: Datasets -->
      <div class="panel" id="datasets-panel">
        <div class="panel-header">
          <h3>Datasets</h3>
          <button class="btn-action" id="btn-load-builtin">Load Built-in</button>
        </div>
        <div class="empty">No datasets loaded</div>
      </div>

      <!-- M-UI-5: Generate Dataset -->
      <div class="panel" id="generate-panel">
        <h3>Generate Dataset</h3>
        <div class="add-task-form">
          <div class="train-row">
            <label class="train-label">Generator</label>
            <select id="gen-name" class="compare-select"></select>
          </div>
          <div class="train-row">
            <label class="train-label">Count</label>
            <input type="number" id="gen-count" class="train-input" value="1000" min="1" />
          </div>
          <div class="train-row">
            <label class="train-label">Image size</label>
            <input type="number" id="gen-size" class="train-input" value="32" min="1" />
          </div>
          <button class="btn-action" id="btn-generate">Generate</button>
        </div>
      </div>

      <!-- M-UI-6: Latent Traversals -->
      <div class="panel" id="traversals-panel">
        <div class="panel-header">
          <h3>Latent Traversals</h3>
          <button class="btn-action" id="btn-traversals">Generate</button>
        </div>
        <div class="empty">Click "Generate" to see latent traversals per factor</div>
      </div>

      <!-- M-UI-6: Sort by Factor -->
      <div class="panel" id="sort-panel">
        <div class="panel-header">
          <h3>Sort by Factor</h3>
          <button class="btn-action" id="btn-sort">Generate</button>
        </div>
        <div class="empty">Click "Generate" to see images sorted by factor activation</div>
      </div>

      <!-- M-UI-6: Attention Maps -->
      <div class="panel" id="attention-panel">
        <div class="panel-header">
          <h3>Attention Maps</h3>
          <button class="btn-action" id="btn-attention">Generate</button>
        </div>
        <div class="empty">Click "Generate" to see attention heatmaps</div>
      </div>
    </main>
  </div>
</Layout>

<script>
  import {
    $dashboard, $checkpoint, $model, $currentJob,
    $lossSummary, $recipe, $jobHistory,
    $evalResults, $evalLoading, $evalError,
    $reconstructions, $reconLoading,
    $checkpointComparison, $compareLoading,
    $evalSiblings,
    $featureSiblings, $featureSiblingsLoading,
    $checkpointTree, $checkpointCurrentId,
    $tasks, $registryTasks, $datasets, $datasetSamples,
    $generators, $device, $recipes,
    $traversals, $traversalsLoading,
    $sortByFactor, $sortByFactorLoading,
    $attentionMaps, $attentionMapsLoading,
    $capabilities,
    startPolling, loadJobLoss, runEval, runReconstructions, runCheckpointComparison,
    saveCheckpoint, loadCheckpoint, forkCheckpoint,
    addTask, toggleTask, setTaskWeight, removeTask,
    loadBuiltinDataset, generateDataset, fetchDatasetSamples,
    startTraining, stopTraining, setDevice,
    runRecipe, stopRecipe,
    fetchTraversals, fetchSortByFactor, fetchAttentionMaps,
    fetchEvalSiblings, fetchFeatureSiblings,
  } from '../lib/store';
  import { metricClass } from '../lib/theme';
  import { HEALTH_COLORS, HEALTH_FALLBACK, STATUS_COLORS, TREND_ICONS } from '../lib/theme';

  // --- DOM refs ---
  const checkpointTag = document.getElementById('checkpoint-tag')!;
  const checkpointDetail = document.getElementById('checkpoint-detail')!;
  const stepEl = document.getElementById('step-value')!;
  const lossEl = document.getElementById('loss-value')!;
  const healthDot = document.getElementById('health-dot')!;
  const healthText = document.getElementById('health-text')!;
  const modelPanel = document.getElementById('model-panel')!;
  const lossSummaryPanel = document.getElementById('loss-summary-panel')!;
  const recipePanel = document.getElementById('recipe-panel')!;
  const jobHistoryPanel = document.getElementById('job-history-panel')!;

  // --- Subscriptions: each fires when its slice changes ---

  // Checkpoint context bar
  $checkpoint.subscribe(cp => {
    if (!cp) return;
    if (!cp.has_model) {
      checkpointTag.textContent = 'No Model';
      checkpointTag.className = 'checkpoint-tag checkpoint-tag--empty';
      checkpointDetail.textContent = 'Load a model or run a recipe to begin';
    } else if (cp.checkpoint) {
      checkpointTag.textContent = cp.checkpoint.tag;
      checkpointTag.className = 'checkpoint-tag';
      const parts = [];
      if (cp.checkpoint.recipe_name) parts.push(cp.checkpoint.recipe_name);
      parts.push(`step ${cp.checkpoint.step.toLocaleString()}`);
      parts.push(cp.checkpoint.id.slice(0, 8));
      checkpointDetail.textContent = parts.join(' \u00B7 ');
    } else {
      checkpointTag.textContent = 'Unsaved State';
      checkpointTag.className = 'checkpoint-tag checkpoint-tag--unsaved';
      checkpointDetail.textContent = 'Model loaded but not checkpointed';
    }
  });

  // Health + connection
  $dashboard.subscribe(s => {
    if (s.connected) {
      healthDot.style.background = HEALTH_COLORS['healthy'];
      healthText.textContent = s.health?.device ?? '--';
    } else if (s.health !== null) {
      healthDot.style.background = '#f85149';
      healthText.textContent = 'Disconnected';
    }
  });

  // Step counter
  $currentJob.subscribe(job => {
    stepEl.textContent = job ? job.current_step.toLocaleString() : 'Idle';
  });

  // Live loss value
  $lossSummary.subscribe(summary => {
    if (!summary) {
      lossEl.textContent = '--';
      lossEl.style.color = '';
      return;
    }
    const entries = Object.values(summary);
    if (entries.length === 0) {
      lossEl.textContent = '--';
      lossEl.style.color = '';
    } else if (entries.length === 1) {
      lossEl.textContent = entries[0].final.toFixed(4);
      lossEl.style.color = HEALTH_COLORS[entries[0].health] || '';
    } else {
      lossEl.textContent = entries.reduce((s, e) => s + e.final, 0).toFixed(4);
      lossEl.style.color = '';
    }
  });

  // Model info
  $model.subscribe(data => {
    if (!data) {
      modelPanel.innerHTML = `<h3>Model</h3><div class="empty">No model loaded</div>`;
      return;
    }
    modelPanel.innerHTML = `
      <h3>Model</h3>
      <div class="model-info-grid">
        <span class="label">Latent dim</span>
        <span class="value">${data.latent_dim}</span>
        <span class="label">Encoder</span>
        <span class="value">${data.num_encoder_layers} layers</span>
        <span class="label">Decoder</span>
        <span class="value">${data.num_decoder_layers} layers${data.has_decoder ? '' : ' (none)'}</span>
      </div>
    `;
  });

  // Loss summary table
  $lossSummary.subscribe(summary => {
    if (!summary) {
      lossSummaryPanel.innerHTML = `<h3>Loss Summary</h3><div class="empty">No training data</div>`;
      return;
    }
    const entries = Object.values(summary);
    if (entries.length === 0) {
      lossSummaryPanel.innerHTML = `<h3>Loss Summary</h3><div class="empty">No training data</div>`;
      return;
    }
    const rows = entries.map(e => {
      const healthColor = HEALTH_COLORS[e.health] || HEALTH_FALLBACK;
      const trend = TREND_ICONS[e.trend] || TREND_ICONS['flat'];
      return `<tr>
        <td>${esc(e.task_name)}</td>
        <td style="color: ${healthColor}">${e.final.toFixed(4)}</td>
        <td>${e.mean.toFixed(4)}</td>
        <td>${e.min.toFixed(4)}</td>
        <td class="trend-${e.trend}">${trend.icon} ${e.trend}</td>
      </tr>`;
    }).join('');

    lossSummaryPanel.innerHTML = `
      <h3>Loss Summary</h3>
      <table class="loss-summary-table">
        <thead><tr><th>Task</th><th>Final</th><th>Mean</th><th>Min</th><th>Trend</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  });

  // Recipe progress
  $recipe.subscribe(data => {
    if (!data) {
      recipePanel.innerHTML = `<h3>Recipe</h3><div class="empty">No recipe running</div>`;
      return;
    }
    const stateColor = STATUS_COLORS[data.state] || '#8b949e';
    const phases = data.phases_completed.map(p =>
      `<div class="recipe-phase done">${esc(p)}</div>`
    ).join('');
    const current = data.state === 'running'
      ? `<div class="recipe-phase current">${esc(data.current_phase)}</div>` : '';
    const branch = data.total_branches > 0
      ? `<div class="recipe-branch-info">Branch ${data.branch_index}/${data.total_branches}${data.current_branch ? ': ' + esc(data.current_branch) : ''}</div>` : '';

    recipePanel.innerHTML = `
      <h3>Recipe</h3>
      <div class="recipe-header">
        <span class="recipe-name">${esc(data.recipe_name)}</span>
        <span class="recipe-state" style="color: ${stateColor}">${data.state}</span>
      </div>
      ${branch}
      <div class="recipe-phases">${phases}${current}</div>
      ${data.error ? `<div class="recipe-error">${esc(data.error)}</div>` : ''}
    `;
  });

  // Job history
  let selectedJobId: string | null = null;

  $jobHistory.subscribe(jobs => {
    if (!jobs || jobs.length === 0) {
      jobHistoryPanel.innerHTML = `<h3>Job History</h3><div class="empty">No jobs</div>`;
      return;
    }
    const rows = jobs.map(job => {
      const stateColor = STATUS_COLORS[job.state] || '#8b949e';
      const healthColor = HEALTH_COLORS[job.overall_health] || HEALTH_FALLBACK;
      const isSelected = job.id === selectedJobId;
      const losses = Object.entries(job.final_losses)
        .map(([name, fl]) => `${name}: ${fl.loss.toFixed(4)}`).join(', ');
      const time = new Date(job.started_at).toLocaleTimeString();
      return `<div class="job-item${isSelected ? ' job-selected' : ''}" data-job-id="${job.id}">
        <div class="job-item-header">
          <span class="job-item-state" style="color: ${stateColor}">${job.state}</span>
          <span class="job-item-steps">${job.current_step.toLocaleString()}/${job.total_steps.toLocaleString()}</span>
          <span class="job-item-time text-muted">${time}</span>
        </div>
        <div class="job-item-losses" style="color: ${healthColor}">${losses || 'No loss data'}</div>
      </div>`;
    }).join('');

    const liveBtn = selectedJobId
      ? `<button class="btn-live" id="btn-live">Back to live</button>` : '';

    jobHistoryPanel.innerHTML = `<h3>Job History</h3>${liveBtn}<div class="job-list">${rows}</div>`;

    jobHistoryPanel.querySelectorAll('.job-item').forEach(el => {
      el.addEventListener('click', () => {
        selectedJobId = (el as HTMLElement).dataset.jobId!;
        loadJobLoss(selectedJobId);
      });
    });
    document.getElementById('btn-live')?.addEventListener('click', () => {
      selectedJobId = null;
    });
  });

  // --- Eval Metrics ---
  const evalPanel = document.getElementById('eval-panel')!;
  const btnEval = document.getElementById('btn-eval')!;

  btnEval.addEventListener('click', () => runEval());

  $evalLoading.subscribe(loading => {
    btnEval.textContent = loading ? 'Running...' : 'Run Eval';
    (btnEval as HTMLButtonElement).disabled = loading;
  });

  // Higher-is-better metrics (used for sibling comparison highlighting)
  const HIGHER_IS_BETTER = new Set([
    'accuracy', 'psnr', 'ufr', 'disentanglement', 'completeness',
    'sparsity_variance', 'effective_rank',
  ]);

  function renderEvalPanel() {
    const evalData = $evalResults.get();
    const siblings = $evalSiblings.get();

    if (!evalData) return;
    const tasks = Object.entries(evalData);
    if (tasks.length === 0) return;

    // If we have sibling checkpoints with eval data, show comparison table
    const hasSiblings = siblings && siblings.siblings.length > 1
      && siblings.siblings.some(s => Object.keys(s.eval_results).length > 0);

    if (hasSiblings) {
      const sibs = siblings!.siblings;
      const currentId = siblings!.current_id;

      // Collect all task+metric combos across all siblings
      const allRows: { task: string; metric: string }[] = [];
      const seen = new Set<string>();
      for (const sib of sibs) {
        for (const [taskName, metrics] of Object.entries(sib.eval_results)) {
          for (const metricName of Object.keys(metrics)) {
            const key = `${taskName}|${metricName}`;
            if (!seen.has(key)) {
              seen.add(key);
              allRows.push({ task: taskName, metric: metricName });
            }
          }
        }
      }

      // Header: Task | Metric | checkpoint1 | checkpoint2 | ...
      const headerCells = sibs.map(s => {
        const isCurrent = s.id === currentId;
        const label = esc(s.tag);
        return `<th class="${isCurrent ? 'sibling-current' : ''}">${label}</th>`;
      }).join('');

      const bodyRows = allRows.map(({ task, metric }) => {
        // Collect values for this metric across all siblings
        const values = sibs.map(s => s.eval_results[task]?.[metric] ?? null);
        const validValues = values.filter((v): v is number => v !== null);
        const hib = HIGHER_IS_BETTER.has(metric);
        const bestVal = validValues.length > 0
          ? (hib ? Math.max(...validValues) : Math.min(...validValues))
          : null;

        const cells = sibs.map((s, i) => {
          const val = values[i];
          const isCurrent = s.id === currentId;
          if (val === null) return `<td class="${isCurrent ? 'sibling-current' : ''}">-</td>`;
          const isBest = bestVal !== null && val === bestVal && validValues.length > 1;
          const cls = [
            isCurrent ? 'sibling-current' : '',
            isBest ? 'sibling-best' : '',
          ].filter(Boolean).join(' ');
          return `<td class="${cls}">${val.toFixed(4)}</td>`;
        }).join('');

        return `<tr><td>${esc(task)}</td><td>${esc(metric)}</td>${cells}</tr>`;
      }).join('');

      evalPanel.innerHTML = `
        <div class="panel-header">
          <h3>Eval Metrics</h3>
          <button class="btn-action" id="btn-eval">Run Eval</button>
        </div>
        <table class="loss-summary-table sibling-table">
          <thead><tr><th>Task</th><th>Metric</th>${headerCells}</tr></thead>
          <tbody>${bodyRows}</tbody>
        </table>
      `;
    } else {
      // No siblings — single-column eval table
      const rows = tasks.flatMap(([taskName, metrics]) =>
        Object.entries(metrics).map(([metricName, value]) => {
          const cls = metricClass(metricName, value);
          return `<tr>
            <td>${esc(taskName)}</td>
            <td>${esc(metricName)}</td>
            <td class="${cls ? 'metric-' + cls : ''}">${value.toFixed(4)}</td>
          </tr>`;
        })
      ).join('');

      evalPanel.innerHTML = `
        <div class="panel-header">
          <h3>Eval Metrics</h3>
          <button class="btn-action" id="btn-eval">Run Eval</button>
        </div>
        <table class="loss-summary-table">
          <thead><tr><th>Task</th><th>Metric</th><th>Value</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      `;
    }
    // Re-attach button handler
    document.getElementById('btn-eval')!.addEventListener('click', () => runEval());
  }

  $evalResults.subscribe(() => renderEvalPanel());
  $evalSiblings.subscribe(() => renderEvalPanel());

  $evalError.subscribe(err => {
    if (!err) return;
    const existing = evalPanel.querySelector('.eval-error');
    if (existing) existing.remove();
    evalPanel.insertAdjacentHTML('beforeend', `<div class="eval-error recipe-error">${esc(err)}</div>`);
  });

  // --- Reconstructions ---
  const reconPanel = document.getElementById('recon-panel')!;
  const btnRecon = document.getElementById('btn-recon')!;

  btnRecon.addEventListener('click', () => runReconstructions());

  $reconLoading.subscribe(loading => {
    btnRecon.textContent = loading ? 'Generating...' : 'Generate';
    (btnRecon as HTMLButtonElement).disabled = loading;
  });

  $reconstructions.subscribe(data => {
    if (!data) return;
    const cols = data.originals.map((orig, i) => {
      const recon = data.reconstructions[i];
      return `<div class="recon-col">
        <img src="data:image/png;base64,${orig}" alt="Original" class="recon-img" />
        <img src="data:image/png;base64,${recon}" alt="Reconstruction" class="recon-img" />
      </div>`;
    }).join('');

    reconPanel.innerHTML = `
      <div class="panel-header">
        <h3>Reconstructions</h3>
        <button class="btn-action" id="btn-recon">Generate</button>
      </div>
      <div class="recon-grid">
        <div class="recon-row-labels">
          <span class="recon-row-label">Input</span>
          <span class="recon-row-label">Recon</span>
        </div>
        ${cols}
      </div>
    `;
    document.getElementById('btn-recon')!.addEventListener('click', () => runReconstructions());
  });

  // --- Checkpoint Tree ---
  const treePanel = document.getElementById('checkpoint-tree-panel')!;
  const saveForm = document.getElementById('save-form')!;
  const saveTagInput = document.getElementById('save-tag') as HTMLInputElement;
  const btnSaveToggle = document.getElementById('btn-save-toggle')!;
  const btnSave = document.getElementById('btn-save')!;

  btnSaveToggle.addEventListener('click', () => {
    saveForm.style.display = saveForm.style.display === 'none' ? 'flex' : 'none';
    if (saveForm.style.display !== 'none') saveTagInput.focus();
  });

  btnSave.addEventListener('click', async () => {
    const tag = saveTagInput.value.trim() || 'checkpoint';
    (btnSave as HTMLButtonElement).disabled = true;
    btnSave.textContent = 'Saving...';
    await saveCheckpoint(tag);
    saveTagInput.value = '';
    saveForm.style.display = 'none';
    btnSave.textContent = 'Save Checkpoint';
    (btnSave as HTMLButtonElement).disabled = false;
  });

  saveTagInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') btnSave.click();
  });

  /** Build tree nodes with indentation based on parent_id. */
  function renderTree(nodes: typeof $checkpointTree.value, currentId: string | null): string {
    if (nodes.length === 0) return '<div class="empty">No checkpoints</div>';

    // Build parent->children map
    const childMap = new Map<string | null, typeof nodes>();
    for (const n of nodes) {
      const pid = n.parent_id;
      if (!childMap.has(pid)) childMap.set(pid, []);
      childMap.get(pid)!.push(n);
    }

    const html: string[] = [];

    function walk(parentId: string | null, depth: number) {
      const children = childMap.get(parentId) ?? [];
      // Sort by timestamp descending (newest first)
      children.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
      for (const node of children) {
        const isCurrent = node.id === currentId;
        const date = new Date(node.timestamp).toLocaleDateString();
        const step = node.step.toLocaleString();
        html.push(`
          <div class="cp-node${isCurrent ? ' cp-current' : ''}" style="padding-left: ${depth * 16 + 8}px" data-cp-id="${node.id}">
            <div class="cp-node-header">
              <span class="cp-tag">${esc(node.tag)}</span>
              ${isCurrent ? '<span class="cp-badge">current</span>' : ''}
            </div>
            <div class="cp-node-detail">
              step ${step} &middot; ${date} &middot; ${node.id.slice(0, 8)}
            </div>
            <div class="cp-node-actions">
              ${!isCurrent ? `<button class="btn-cp btn-cp-load" data-action="load" data-cp-id="${node.id}">Load</button>` : ''}
              <button class="btn-cp btn-cp-fork" data-action="fork" data-cp-id="${node.id}" data-cp-tag="${esc(node.tag)}">Fork</button>
            </div>
          </div>
        `);
        walk(node.id, depth + 1);
      }
    }

    walk(null, 0);
    // Also render orphan roots (nodes whose parent isn't in the tree)
    const allIds = new Set(nodes.map(n => n.id));
    for (const n of nodes) {
      if (n.parent_id && !allIds.has(n.parent_id) && !childMap.get(null)?.includes(n)) {
        // This node's parent doesn't exist, treat as root
        if (!html.some(h => h.includes(`data-cp-id="${n.id}"`))) {
          walk(n.id, 0);
        }
      }
    }

    return html.join('');
  }

  $checkpointTree.subscribe(nodes => {
    const currentId = $checkpointCurrentId.get();
    const treeHtml = renderTree(nodes, currentId);

    // Preserve save form and header, only replace tree content
    const existingTree = treePanel.querySelector('.cp-tree');
    const emptyEl = treePanel.querySelector('.empty');
    if (existingTree) {
      existingTree.innerHTML = treeHtml;
    } else if (emptyEl && nodes.length > 0) {
      emptyEl.remove();
      const treeDiv = document.createElement('div');
      treeDiv.className = 'cp-tree';
      treeDiv.innerHTML = treeHtml;
      treePanel.appendChild(treeDiv);
    }

    // Attach action handlers via delegation
    treePanel.querySelectorAll('.btn-cp').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        e.stopPropagation();
        const el = btn as HTMLElement;
        const action = el.dataset.action;
        const cpId = el.dataset.cpId!;
        if (action === 'load') {
          el.textContent = 'Loading...';
          await loadCheckpoint(cpId);
        } else if (action === 'fork') {
          const newTag = prompt('Fork tag:', el.dataset.cpTag + '-fork');
          if (newTag) {
            el.textContent = 'Forking...';
            await forkCheckpoint(cpId, newTag);
          }
        }
      });
    });
  });

  // Also update compare dropdown from store tree data
  $checkpointTree.subscribe(nodes => {
    const currentId = $checkpointCurrentId.get();
    const opts = nodes
      .filter(n => n.id !== currentId)
      .map(n => `<option value="${n.id}">${esc(n.tag)} (${n.id.slice(0, 8)})</option>`)
      .join('');
    const selects = document.querySelectorAll('#compare-select');
    selects.forEach(sel => {
      (sel as HTMLSelectElement).innerHTML = `<option value="">Select checkpoint...</option>${opts}`;
    });
  });

  // --- Checkpoint Comparison ---
  const comparePanel = document.getElementById('compare-panel')!;
  const compareSelect = document.getElementById('compare-select') as HTMLSelectElement;
  const btnCompare = document.getElementById('btn-compare') as HTMLButtonElement;

  compareSelect.addEventListener('change', () => {
    btnCompare.disabled = !compareSelect.value;
  });

  btnCompare.addEventListener('click', () => {
    if (compareSelect.value) runCheckpointComparison(compareSelect.value);
  });

  $compareLoading.subscribe(loading => {
    btnCompare.textContent = loading ? 'Comparing...' : 'Compare';
    btnCompare.disabled = loading || !compareSelect.value;
  });

  $checkpointComparison.subscribe(data => {
    if (!data) return;
    const { current, compare } = data;

    // Collect all unique task+metric combos
    const allTasks = new Set([...Object.keys(current), ...Object.keys(compare.metrics)]);
    const rows: string[] = [];

    for (const task of allTasks) {
      const curMetrics = current[task] ?? {};
      const cmpMetrics = compare.metrics[task] ?? {};
      const allMetricNames = new Set([...Object.keys(curMetrics), ...Object.keys(cmpMetrics)]);

      for (const metric of allMetricNames) {
        const curVal = curMetrics[metric];
        const cmpVal = cmpMetrics[metric];
        const curStr = curVal !== undefined ? curVal.toFixed(4) : '-';
        const cmpStr = cmpVal !== undefined ? cmpVal.toFixed(4) : '-';

        // Determine which is better
        let curCls = '', cmpCls = '';
        if (curVal !== undefined && cmpVal !== undefined) {
          const cls = metricClass(metric, curVal);
          const clsCmp = metricClass(metric, cmpVal);
          // Highlight the better one
          if (cls === 'good' && clsCmp !== 'good') curCls = 'compare-better';
          else if (clsCmp === 'good' && cls !== 'good') cmpCls = 'compare-better';
          else if (curVal !== cmpVal) {
            // For metrics without thresholds, just show difference
            const diff = curVal - cmpVal;
            curCls = diff > 0 ? 'compare-higher' : 'compare-lower';
            cmpCls = diff > 0 ? 'compare-lower' : 'compare-higher';
          }
        }

        rows.push(`<tr>
          <td>${esc(task)}</td>
          <td>${esc(metric)}</td>
          <td class="${curCls}">${curStr}</td>
          <td class="${cmpCls}">${cmpStr}</td>
        </tr>`);
      }
    }

    comparePanel.innerHTML = `
      <div class="panel-header">
        <h3>Checkpoint Comparison</h3>
        <div class="compare-controls">
          <select id="compare-select" class="compare-select">
            ${compareSelect.innerHTML}
          </select>
          <button class="btn-action" id="btn-compare">Compare</button>
        </div>
      </div>
      <div class="compare-header">
        <span class="compare-label">Current</span>
        <span class="compare-vs">vs</span>
        <span class="compare-label">${esc(compare.tag)} (${compare.checkpoint_id.slice(0, 8)})</span>
      </div>
      <table class="loss-summary-table compare-table">
        <thead><tr><th>Task</th><th>Metric</th><th>Current</th><th>${esc(compare.tag)}</th></tr></thead>
        <tbody>${rows.join('')}</tbody>
      </table>
    `;
    // Re-attach handlers after innerHTML replacement
    const newSelect = document.getElementById('compare-select') as HTMLSelectElement;
    const newBtn = document.getElementById('btn-compare') as HTMLButtonElement;
    newSelect.addEventListener('change', () => {
      newBtn.disabled = !newSelect.value;
    });
    newBtn.addEventListener('click', () => {
      if (newSelect.value) runCheckpointComparison(newSelect.value);
    });
  });

  // --- Weight Features Panel ---
  const featuresPanel = document.getElementById('features-panel')!;
  const btnFeatures = document.getElementById('btn-features')!;

  btnFeatures.addEventListener('click', () => fetchFeatureSiblings());

  $featureSiblingsLoading.subscribe(loading => {
    btnFeatures.textContent = loading ? 'Loading...' : 'Load Features';
    (btnFeatures as HTMLButtonElement).disabled = loading;
  });

  let featureScale = 3; // 3x = 84px per 28px feature. Adjustable via slider.

  function renderFeatures() {
    const data = $featureSiblings.get();
    if (!data || data.siblings.length === 0) return;

    const { siblings, current_id, n_features, image_shape } = data;
    const nativeW = image_shape[1] || 28;
    const nativeH = image_shape[0] || 28;
    const dispW = nativeW * featureScale;
    const dispH = nativeH * featureScale;
    const gridCols = 8;

    let html = `
      <div class="panel-header">
        <h3>Weight Features</h3>
        <div class="features-controls">
          <label class="features-scale-label">Scale: ${featureScale}x</label>
          <input type="range" id="feature-scale" min="1" max="6" step="1" value="${featureScale}" class="features-slider" />
          <button class="btn-action" id="btn-features">Reload</button>
        </div>
      </div>
      <div class="features-comparison">
    `;

    for (const sib of siblings) {
      const isCurrent = sib.id === current_id;
      const label = esc(sib.tag);
      const desc = sib.description ? ` — ${esc(sib.description)}` : '';
      const cls = isCurrent ? ' features-current' : '';

      html += `<div class="features-block${cls}">`;
      html += `<div class="features-label">${label}${desc}</div>`;
      html += `<div class="features-grid" style="grid-template-columns: repeat(${gridCols}, ${dispW}px); gap: 2px;">`;
      for (let i = 0; i < n_features && i < sib.features.length; i++) {
        html += `<img src="data:image/png;base64,${sib.features[i]}" width="${dispW}" height="${dispH}" class="feature-img" data-idx="${i}" title="Feature ${i}" />`;
      }
      html += `</div></div>`;
    }

    html += `</div>`;

    // Zoom overlay (hidden by default, shown on click)
    html += `<div id="feature-zoom-overlay" class="feature-zoom-overlay" style="display:none;">
      <img id="feature-zoom-img" class="feature-zoom-img" />
      <div id="feature-zoom-caption" class="feature-zoom-caption"></div>
    </div>`;

    featuresPanel.innerHTML = html;

    // Re-attach handlers
    document.getElementById('btn-features')!.addEventListener('click', () => fetchFeatureSiblings());

    const slider = document.getElementById('feature-scale') as HTMLInputElement;
    slider.addEventListener('input', () => {
      featureScale = parseInt(slider.value);
      renderFeatures();
    });

    // Click-to-zoom: clicking any feature image shows it large
    const overlay = document.getElementById('feature-zoom-overlay')!;
    const zoomImg = document.getElementById('feature-zoom-img') as HTMLImageElement;
    const zoomCaption = document.getElementById('feature-zoom-caption')!;

    featuresPanel.querySelectorAll('.feature-img').forEach(img => {
      img.addEventListener('click', (e) => {
        const el = e.currentTarget as HTMLImageElement;
        zoomImg.src = el.src;
        const idx = el.getAttribute('data-idx') || '?';
        const block = el.closest('.features-block');
        const label = block?.querySelector('.features-label')?.textContent || '';
        zoomCaption.textContent = `${label} — Feature ${idx}`;
        overlay.style.display = 'flex';
      });
    });

    overlay.addEventListener('click', () => {
      overlay.style.display = 'none';
    });
  }

  $featureSiblings.subscribe(() => renderFeatures());

  // --- M-UI-5: Tasks Panel ---
  const tasksPanel = document.getElementById('tasks-panel')!;

  $tasks.subscribe(tasks => {
    if (!tasks || tasks.length === 0) {
      tasksPanel.innerHTML = `<h3>Tasks</h3><div class="empty">No tasks configured</div>`;
      return;
    }
    const rows = tasks.map(t => {
      const enabledCls = t.enabled ? '' : ' task-disabled';
      return `<div class="task-item${enabledCls}" data-task-name="${esc(t.name)}">
        <div class="task-item-header">
          <span class="task-item-name">${esc(t.name)}</span>
          <span class="task-item-type text-muted">${esc(t.class_name)}</span>
        </div>
        <div class="task-item-detail">
          <span>dataset: ${esc(t.dataset_name)}</span>
          <span>weight: <input type="number" class="task-weight-input" value="${t.weight}" step="0.1" min="0" data-task-name="${esc(t.name)}" /></span>
        </div>
        <div class="task-item-actions">
          <button class="btn-cp" data-action="toggle" data-task-name="${esc(t.name)}">${t.enabled ? 'Disable' : 'Enable'}</button>
          <button class="btn-cp" data-action="remove" data-task-name="${esc(t.name)}" style="color:var(--red)">Remove</button>
        </div>
      </div>`;
    }).join('');

    tasksPanel.innerHTML = `<h3>Tasks</h3><div class="task-list">${rows}</div>`;

    tasksPanel.querySelectorAll('button[data-action="toggle"]').forEach(btn => {
      btn.addEventListener('click', () => toggleTask((btn as HTMLElement).dataset.taskName!));
    });
    tasksPanel.querySelectorAll('button[data-action="remove"]').forEach(btn => {
      btn.addEventListener('click', () => {
        if (confirm('Remove task?')) removeTask((btn as HTMLElement).dataset.taskName!);
      });
    });
    tasksPanel.querySelectorAll('.task-weight-input').forEach(inp => {
      (inp as HTMLInputElement).addEventListener('change', () => {
        const el = inp as HTMLInputElement;
        setTaskWeight(el.dataset.taskName!, parseFloat(el.value));
      });
    });
  });

  // --- M-UI-5: Add Task Form ---
  const taskClassSelect = document.getElementById('task-class') as HTMLSelectElement;
  const taskDatasetSelect = document.getElementById('task-dataset') as HTMLSelectElement;
  const btnAddTask = document.getElementById('btn-add-task')!;

  $registryTasks.subscribe(reg => {
    taskClassSelect.innerHTML = reg.map(r =>
      `<option value="${esc(r.class_name)}">${esc(r.class_name)}</option>`
    ).join('');
  });

  $datasets.subscribe(ds => {
    taskDatasetSelect.innerHTML = ds.map(d =>
      `<option value="${esc(d.name)}">${esc(d.name)} (${d.size})</option>`
    ).join('');
  });

  btnAddTask.addEventListener('click', async () => {
    const className = taskClassSelect.value;
    const name = (document.getElementById('task-name') as HTMLInputElement).value.trim();
    const datasetName = taskDatasetSelect.value;
    const weight = parseFloat((document.getElementById('task-weight') as HTMLInputElement).value);
    if (!className || !name || !datasetName) return;
    (btnAddTask as HTMLButtonElement).disabled = true;
    btnAddTask.textContent = 'Adding...';
    await addTask({ class_name: className, name, dataset_name: datasetName, weight });
    btnAddTask.textContent = 'Add Task';
    (btnAddTask as HTMLButtonElement).disabled = false;
    (document.getElementById('task-name') as HTMLInputElement).value = '';
  });

  // --- M-UI-5: Training Controls ---
  const btnTrainStart = document.getElementById('btn-train-start') as HTMLButtonElement;
  const btnTrainStop = document.getElementById('btn-train-stop') as HTMLButtonElement;

  btnTrainStart.addEventListener('click', async () => {
    const steps = parseInt((document.getElementById('train-steps') as HTMLInputElement).value);
    const lr = parseFloat((document.getElementById('train-lr') as HTMLInputElement).value);
    btnTrainStart.disabled = true;
    btnTrainStart.textContent = 'Starting...';
    await startTraining({ steps, lr });
    btnTrainStart.textContent = 'Start Training';
    btnTrainStart.disabled = false;
  });

  btnTrainStop.addEventListener('click', async () => {
    btnTrainStop.disabled = true;
    btnTrainStop.textContent = 'Stopping...';
    await stopTraining();
    btnTrainStop.textContent = 'Stop';
    btnTrainStop.disabled = false;
  });

  $currentJob.subscribe(job => {
    // Already handles step counter above; also toggle train buttons
    btnTrainStart.disabled = !!job;
    btnTrainStop.disabled = !job;
  });

  // --- M-UI-5: Device ---
  const deviceSelect = document.getElementById('device-select') as HTMLSelectElement;

  $device.subscribe(dev => {
    if (!dev) return;
    deviceSelect.innerHTML = dev.available.map(d =>
      `<option value="${esc(d)}"${d === dev.current ? ' selected' : ''}>${esc(d)}</option>`
    ).join('');
  });

  deviceSelect.addEventListener('change', () => {
    if (deviceSelect.value) setDevice(deviceSelect.value);
  });

  // --- M-UI-5: Recipes List ---
  const recipesPanel = document.getElementById('recipes-panel')!;

  $recipes.subscribe(recipes => {
    if (!recipes || recipes.length === 0) {
      recipesPanel.innerHTML = `<h3>Run Recipe</h3><div class="empty">No recipes available</div>`;
      return;
    }
    const rows = recipes.map(r =>
      `<div class="recipe-item">
        <span class="recipe-item-name">${esc(r.name)}</span>
        <span class="recipe-item-desc text-muted">${esc(r.description)}</span>
        <button class="btn-cp btn-cp-load" data-recipe="${esc(r.name)}">Run</button>
      </div>`
    ).join('');
    recipesPanel.innerHTML = `<h3>Run Recipe</h3><div class="recipe-list">${rows}</div>`;

    recipesPanel.querySelectorAll('button[data-recipe]').forEach(btn => {
      btn.addEventListener('click', async () => {
        const el = btn as HTMLElement;
        el.textContent = 'Starting...';
        await runRecipe(el.dataset.recipe!);
        el.textContent = 'Run';
      });
    });
  });

  // --- M-UI-5: Datasets Panel ---
  const datasetsPanel = document.getElementById('datasets-panel')!;
  const btnLoadBuiltin = document.getElementById('btn-load-builtin')!;

  btnLoadBuiltin.addEventListener('click', async () => {
    const name = prompt('Built-in dataset name:', 'mnist');
    if (!name) return;
    const size = parseInt(prompt('Image size:', '64') || '64');
    btnLoadBuiltin.textContent = 'Loading...';
    (btnLoadBuiltin as HTMLButtonElement).disabled = true;
    await loadBuiltinDataset(name, size);
    btnLoadBuiltin.textContent = 'Load Built-in';
    (btnLoadBuiltin as HTMLButtonElement).disabled = false;
  });

  $datasets.subscribe(datasets => {
    if (!datasets || datasets.length === 0) {
      datasetsPanel.innerHTML = `
        <div class="panel-header"><h3>Datasets</h3>
          <button class="btn-action" id="btn-load-builtin">Load Built-in</button>
        </div>
        <div class="empty">No datasets loaded</div>`;
      document.getElementById('btn-load-builtin')?.addEventListener('click', async () => {
        const name = prompt('Built-in dataset name:', 'mnist');
        if (name) await loadBuiltinDataset(name, parseInt(prompt('Image size:', '64') || '64'));
      });
      return;
    }
    const rows = datasets.map(d =>
      `<div class="dataset-item">
        <div class="dataset-item-header">
          <span class="dataset-item-name">${esc(d.name)}</span>
          <span class="text-muted">${d.size} images, ${d.image_size}x${d.image_size}</span>
          <button class="btn-cp btn-cp-load" data-ds-name="${esc(d.name)}">Samples</button>
        </div>
        <div class="dataset-samples" id="ds-samples-${esc(d.name)}"></div>
      </div>`
    ).join('');

    datasetsPanel.innerHTML = `
      <div class="panel-header"><h3>Datasets</h3>
        <button class="btn-action" id="btn-load-builtin">Load Built-in</button>
      </div>
      <div class="dataset-list">${rows}</div>`;

    document.getElementById('btn-load-builtin')?.addEventListener('click', async () => {
      const name = prompt('Built-in dataset name:', 'mnist');
      if (name) await loadBuiltinDataset(name, parseInt(prompt('Image size:', '64') || '64'));
    });

    datasetsPanel.querySelectorAll('button[data-ds-name]').forEach(btn => {
      btn.addEventListener('click', () => fetchDatasetSamples((btn as HTMLElement).dataset.dsName!));
    });
  });

  $datasetSamples.subscribe(samples => {
    for (const [name, images] of Object.entries(samples)) {
      const container = document.getElementById(`ds-samples-${name}`);
      if (!container) continue;
      container.innerHTML = images.map(img =>
        `<img src="data:image/png;base64,${img}" class="recon-img" alt="sample" />`
      ).join('');
    }
  });

  // --- M-UI-5: Generate Dataset ---
  const genSelect = document.getElementById('gen-name') as HTMLSelectElement;
  const btnGenerate = document.getElementById('btn-generate')!;

  $generators.subscribe(gens => {
    genSelect.innerHTML = gens.map(g =>
      `<option value="${esc(g.name)}">${esc(g.name)}</option>`
    ).join('');
  });

  btnGenerate.addEventListener('click', async () => {
    const genName = genSelect.value;
    const n = parseInt((document.getElementById('gen-count') as HTMLInputElement).value);
    const imageSize = parseInt((document.getElementById('gen-size') as HTMLInputElement).value);
    if (!genName) return;
    (btnGenerate as HTMLButtonElement).disabled = true;
    btnGenerate.textContent = 'Generating...';
    await generateDataset(genName, { n, image_size: imageSize });
    btnGenerate.textContent = 'Generate';
    (btnGenerate as HTMLButtonElement).disabled = false;
  });

  // --- Capability-gated panel visibility ---
  $capabilities.subscribe(caps => {
    const hide = (id: string, show: boolean) => {
      const el = document.getElementById(id);
      if (el) el.style.display = show ? '' : 'none';
    };
    // Eval + recon panels always visible if model exists (caps != null)
    hide('eval-panel', caps?.eval ?? true);
    hide('recon-panel', caps?.reconstructions ?? true);
    // M-UI-6 panels hidden unless model supports them
    hide('traversals-panel', caps?.traversals ?? false);
    hide('sort-panel', caps?.sort_by_factor ?? false);
    hide('attention-panel', caps?.attention_maps ?? false);
  });

  // --- M-UI-6: Latent Traversals ---
  const traversalsPanel = document.getElementById('traversals-panel')!;
  const btnTraversals = document.getElementById('btn-traversals')!;

  btnTraversals.addEventListener('click', () => fetchTraversals());

  $traversalsLoading.subscribe(loading => {
    btnTraversals.textContent = loading ? 'Loading...' : 'Generate';
    (btnTraversals as HTMLButtonElement).disabled = loading;
  });

  $traversals.subscribe(data => {
    if (!data) return;
    const factors = Object.entries(data);
    if (factors.length === 0) {
      traversalsPanel.innerHTML = `
        <div class="panel-header"><h3>Latent Traversals</h3>
          <button class="btn-action" id="btn-traversals">Generate</button>
        </div>
        <div class="empty">No factor groups in model</div>`;
      document.getElementById('btn-traversals')?.addEventListener('click', () => fetchTraversals());
      return;
    }

    const sections = factors.map(([factorName, rows]) => {
      const imgs = rows.flatMap(row =>
        row.map(img => `<img src="data:image/png;base64,${img}" class="recon-img" alt="traversal" />`)
      ).join('');
      return `<div class="viz-section">
        <div class="viz-section-label">${esc(factorName)}</div>
        <div class="viz-grid">${imgs}</div>
      </div>`;
    }).join('');

    traversalsPanel.innerHTML = `
      <div class="panel-header"><h3>Latent Traversals</h3>
        <button class="btn-action" id="btn-traversals">Generate</button>
      </div>
      ${sections}`;
    document.getElementById('btn-traversals')?.addEventListener('click', () => fetchTraversals());
  });

  // --- M-UI-6: Sort by Factor ---
  const sortPanel = document.getElementById('sort-panel')!;
  const btnSort = document.getElementById('btn-sort')!;

  btnSort.addEventListener('click', () => fetchSortByFactor());

  $sortByFactorLoading.subscribe(loading => {
    btnSort.textContent = loading ? 'Loading...' : 'Generate';
    (btnSort as HTMLButtonElement).disabled = loading;
  });

  $sortByFactor.subscribe(data => {
    if (!data) return;
    const factors = Object.entries(data);
    if (factors.length === 0) return;

    const sections = factors.map(([factorName, { lowest, highest }]) => {
      const lowImgs = lowest.map(img =>
        `<img src="data:image/png;base64,${img}" class="recon-img" alt="low" />`
      ).join('');
      const highImgs = highest.map(img =>
        `<img src="data:image/png;base64,${img}" class="recon-img" alt="high" />`
      ).join('');
      return `<div class="viz-section">
        <div class="viz-section-label">${esc(factorName)}</div>
        <div class="viz-row"><span class="viz-row-label">Lowest</span><div class="viz-grid">${lowImgs}</div></div>
        <div class="viz-row"><span class="viz-row-label">Highest</span><div class="viz-grid">${highImgs}</div></div>
      </div>`;
    }).join('');

    sortPanel.innerHTML = `
      <div class="panel-header"><h3>Sort by Factor</h3>
        <button class="btn-action" id="btn-sort">Generate</button>
      </div>
      ${sections}`;
    document.getElementById('btn-sort')?.addEventListener('click', () => fetchSortByFactor());
  });

  // --- M-UI-6: Attention Maps ---
  const attentionPanel = document.getElementById('attention-panel')!;
  const btnAttention = document.getElementById('btn-attention')!;

  btnAttention.addEventListener('click', () => fetchAttentionMaps());

  $attentionMapsLoading.subscribe(loading => {
    btnAttention.textContent = loading ? 'Loading...' : 'Generate';
    (btnAttention as HTMLButtonElement).disabled = loading;
  });

  $attentionMaps.subscribe(data => {
    if (!data) return;
    const entries = Object.entries(data);
    if (entries.length === 0) return;

    const sections = entries.map(([key, images]) => {
      const imgs = images.map(img =>
        `<img src="data:image/png;base64,${img}" class="recon-img" alt="${esc(key)}" />`
      ).join('');
      return `<div class="viz-section">
        <div class="viz-section-label">${esc(key)}</div>
        <div class="viz-grid">${imgs}</div>
      </div>`;
    }).join('');

    attentionPanel.innerHTML = `
      <div class="panel-header"><h3>Attention Maps</h3>
        <button class="btn-action" id="btn-attention">Generate</button>
      </div>
      ${sections}`;
    document.getElementById('btn-attention')?.addEventListener('click', () => fetchAttentionMaps());
  });

  // --- Start ---
  startPolling();

  function esc(str: string): string {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }
</script>
