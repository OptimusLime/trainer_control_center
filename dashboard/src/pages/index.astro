---
import Layout from '../layouts/Layout.astro';
import LossChart from '../components/LossChart.tsx';
---

<Layout title="ACC Dashboard">
  <div class="dashboard">
    <!-- Checkpoint Context Bar -->
    <header class="header">
      <div class="checkpoint-context" id="checkpoint-context">
        <div class="checkpoint-tag" id="checkpoint-tag">Connecting...</div>
        <div class="checkpoint-detail" id="checkpoint-detail"></div>
      </div>
      <div class="live-stats">
        <div class="live-stat">
          <span class="live-stat-value" id="step-value">--</span>
          <span class="live-stat-label">steps</span>
        </div>
        <div class="live-stat">
          <span class="live-stat-value" id="loss-value">--</span>
          <span class="live-stat-label">loss</span>
        </div>
        <div class="live-stat">
          <div id="health-badge" class="health-badge">
            <span class="health-dot" id="health-dot" style="background: #8b949e;"></span>
            <span id="health-text">--</span>
          </div>
        </div>
      </div>
    </header>

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="panel" id="model-panel">
        <h3>Model</h3>
        <div class="empty">No model loaded</div>
      </div>

      <div class="panel" id="loss-summary-panel">
        <h3>Loss Summary</h3>
        <div class="empty">No training data</div>
      </div>

      <div class="panel" id="recipe-panel">
        <h3>Recipe</h3>
        <div class="empty">No recipe running</div>
      </div>

      <div class="panel" id="job-history-panel">
        <h3>Job History</h3>
        <div class="empty">No jobs</div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main">
      <div class="panel">
        <h3>Loss Curves</h3>
        <LossChart client:load />
      </div>
    </main>
  </div>
</Layout>

<script>
  import {
    $dashboard, $checkpoint, $model, $currentJob,
    $lossSummary, $recipe, $jobHistory,
    startPolling, loadJobLoss,
  } from '../lib/store';
  import { HEALTH_COLORS, HEALTH_FALLBACK, STATUS_COLORS, TREND_ICONS } from '../lib/theme';

  // --- DOM refs ---
  const checkpointTag = document.getElementById('checkpoint-tag')!;
  const checkpointDetail = document.getElementById('checkpoint-detail')!;
  const stepEl = document.getElementById('step-value')!;
  const lossEl = document.getElementById('loss-value')!;
  const healthDot = document.getElementById('health-dot')!;
  const healthText = document.getElementById('health-text')!;
  const modelPanel = document.getElementById('model-panel')!;
  const lossSummaryPanel = document.getElementById('loss-summary-panel')!;
  const recipePanel = document.getElementById('recipe-panel')!;
  const jobHistoryPanel = document.getElementById('job-history-panel')!;

  // --- Subscriptions: each fires when its slice changes ---

  // Checkpoint context bar
  $checkpoint.subscribe(cp => {
    if (!cp) return;
    if (!cp.has_model) {
      checkpointTag.textContent = 'No Model';
      checkpointTag.className = 'checkpoint-tag checkpoint-tag--empty';
      checkpointDetail.textContent = 'Load a model or run a recipe to begin';
    } else if (cp.checkpoint) {
      checkpointTag.textContent = cp.checkpoint.tag;
      checkpointTag.className = 'checkpoint-tag';
      const parts = [];
      if (cp.checkpoint.recipe_name) parts.push(cp.checkpoint.recipe_name);
      parts.push(`step ${cp.checkpoint.step.toLocaleString()}`);
      parts.push(cp.checkpoint.id.slice(0, 8));
      checkpointDetail.textContent = parts.join(' \u00B7 ');
    } else {
      checkpointTag.textContent = 'Unsaved State';
      checkpointTag.className = 'checkpoint-tag checkpoint-tag--unsaved';
      checkpointDetail.textContent = 'Model loaded but not checkpointed';
    }
  });

  // Health + connection
  $dashboard.subscribe(s => {
    if (s.connected) {
      healthDot.style.background = HEALTH_COLORS['healthy'];
      healthText.textContent = s.health?.device ?? '--';
    } else if (s.health !== null) {
      healthDot.style.background = '#f85149';
      healthText.textContent = 'Disconnected';
    }
  });

  // Step counter
  $currentJob.subscribe(job => {
    stepEl.textContent = job ? job.current_step.toLocaleString() : 'Idle';
  });

  // Live loss value
  $lossSummary.subscribe(summary => {
    if (!summary) {
      lossEl.textContent = '--';
      lossEl.style.color = '';
      return;
    }
    const entries = Object.values(summary);
    if (entries.length === 0) {
      lossEl.textContent = '--';
      lossEl.style.color = '';
    } else if (entries.length === 1) {
      lossEl.textContent = entries[0].final.toFixed(4);
      lossEl.style.color = HEALTH_COLORS[entries[0].health] || '';
    } else {
      lossEl.textContent = entries.reduce((s, e) => s + e.final, 0).toFixed(4);
      lossEl.style.color = '';
    }
  });

  // Model info
  $model.subscribe(data => {
    if (!data) {
      modelPanel.innerHTML = `<h3>Model</h3><div class="empty">No model loaded</div>`;
      return;
    }
    modelPanel.innerHTML = `
      <h3>Model</h3>
      <div class="model-info-grid">
        <span class="label">Latent dim</span>
        <span class="value">${data.latent_dim}</span>
        <span class="label">Encoder</span>
        <span class="value">${data.num_encoder_layers} layers</span>
        <span class="label">Decoder</span>
        <span class="value">${data.num_decoder_layers} layers${data.has_decoder ? '' : ' (none)'}</span>
      </div>
    `;
  });

  // Loss summary table
  $lossSummary.subscribe(summary => {
    if (!summary) {
      lossSummaryPanel.innerHTML = `<h3>Loss Summary</h3><div class="empty">No training data</div>`;
      return;
    }
    const entries = Object.values(summary);
    if (entries.length === 0) {
      lossSummaryPanel.innerHTML = `<h3>Loss Summary</h3><div class="empty">No training data</div>`;
      return;
    }
    const rows = entries.map(e => {
      const healthColor = HEALTH_COLORS[e.health] || HEALTH_FALLBACK;
      const trend = TREND_ICONS[e.trend] || TREND_ICONS['flat'];
      return `<tr>
        <td>${esc(e.task_name)}</td>
        <td style="color: ${healthColor}">${e.final.toFixed(4)}</td>
        <td>${e.mean.toFixed(4)}</td>
        <td>${e.min.toFixed(4)}</td>
        <td class="trend-${e.trend}">${trend.icon} ${e.trend}</td>
      </tr>`;
    }).join('');

    lossSummaryPanel.innerHTML = `
      <h3>Loss Summary</h3>
      <table class="loss-summary-table">
        <thead><tr><th>Task</th><th>Final</th><th>Mean</th><th>Min</th><th>Trend</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
    `;
  });

  // Recipe progress
  $recipe.subscribe(data => {
    if (!data) {
      recipePanel.innerHTML = `<h3>Recipe</h3><div class="empty">No recipe running</div>`;
      return;
    }
    const stateColor = STATUS_COLORS[data.state] || '#8b949e';
    const phases = data.phases_completed.map(p =>
      `<div class="recipe-phase done">${esc(p)}</div>`
    ).join('');
    const current = data.state === 'running'
      ? `<div class="recipe-phase current">${esc(data.current_phase)}</div>` : '';
    const branch = data.total_branches > 0
      ? `<div class="recipe-branch-info">Branch ${data.branch_index}/${data.total_branches}${data.current_branch ? ': ' + esc(data.current_branch) : ''}</div>` : '';

    recipePanel.innerHTML = `
      <h3>Recipe</h3>
      <div class="recipe-header">
        <span class="recipe-name">${esc(data.recipe_name)}</span>
        <span class="recipe-state" style="color: ${stateColor}">${data.state}</span>
      </div>
      ${branch}
      <div class="recipe-phases">${phases}${current}</div>
      ${data.error ? `<div class="recipe-error">${esc(data.error)}</div>` : ''}
    `;
  });

  // Job history
  let selectedJobId: string | null = null;

  $jobHistory.subscribe(jobs => {
    if (!jobs || jobs.length === 0) {
      jobHistoryPanel.innerHTML = `<h3>Job History</h3><div class="empty">No jobs</div>`;
      return;
    }
    const rows = jobs.map(job => {
      const stateColor = STATUS_COLORS[job.state] || '#8b949e';
      const healthColor = HEALTH_COLORS[job.overall_health] || HEALTH_FALLBACK;
      const isSelected = job.id === selectedJobId;
      const losses = Object.entries(job.final_losses)
        .map(([name, fl]) => `${name}: ${fl.loss.toFixed(4)}`).join(', ');
      const time = new Date(job.started_at).toLocaleTimeString();
      return `<div class="job-item${isSelected ? ' job-selected' : ''}" data-job-id="${job.id}">
        <div class="job-item-header">
          <span class="job-item-state" style="color: ${stateColor}">${job.state}</span>
          <span class="job-item-steps">${job.current_step.toLocaleString()}/${job.total_steps.toLocaleString()}</span>
          <span class="job-item-time text-muted">${time}</span>
        </div>
        <div class="job-item-losses" style="color: ${healthColor}">${losses || 'No loss data'}</div>
      </div>`;
    }).join('');

    const liveBtn = selectedJobId
      ? `<button class="btn-live" id="btn-live">Back to live</button>` : '';

    jobHistoryPanel.innerHTML = `<h3>Job History</h3>${liveBtn}<div class="job-list">${rows}</div>`;

    jobHistoryPanel.querySelectorAll('.job-item').forEach(el => {
      el.addEventListener('click', () => {
        selectedJobId = (el as HTMLElement).dataset.jobId!;
        loadJobLoss(selectedJobId);
      });
    });
    document.getElementById('btn-live')?.addEventListener('click', () => {
      selectedJobId = null;
    });
  });

  // --- Start ---
  startPolling();

  function esc(str: string): string {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
  }
</script>
